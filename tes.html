<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kaos Designer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
      .canvas-container {
        border: 1px solid #ccc;
        position: relative;
      }
      .font-preview {
        font-size: 14px;
        padding: 4px;
      }
      .btn-toggle.active {
        background-color: #0d6efd;
        color: #fff;
      }
      .ruler {
        position: absolute;
        font-size: 10px;
        color: #555;
        pointer-events: none;
      }
      .ruler-line {
        position: absolute;
        background: rgba(0, 0, 255, 0.5);
        z-index: 10;
      }
    </style>
  </head>
  <body class="bg-light pb-4">
    <div class="container-fluid mt-3">
      <div class="row">
        <div class="col-md-3">
          <!-- Kontrol Panel -->
          <div class="card mb-3">
            <div class="card-body">
              <h5>Kontrol Text</h5>
              <div class="d-grid gap-2 mb-2">
                <button
                  data-bs-toggle="modal"
                  data-bs-target="#fontModal"
                  class="btn btn-primary"
                >
                  Tambah Teks
                </button>
              </div>
              <label>Warna Teks</label>
              <input
                type="color"
                id="textColor"
                class="form-control mb-2"
                value="#000000"
              />
              <label>Warna Background Teks</label>
              <input
                type="color"
                id="textBgColor"
                class="form-control mb-2"
                value="#ffffff"
              />
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="bgTransparent"
                />
                <label class="form-check-label">Transparan</label>
              </div>
              <label>Ukuran Font</label>
              <select id="fontSize" class="form-select mb-2"></select>
              <div class="btn-group mb-2" role="group">
                <button id="boldBtn" class="btn btn-light btn-toggle">B</button>
                <button id="italicBtn" class="btn btn-light btn-toggle">
                  I
                </button>
              </div>
              <div class="btn-group mb-2" role="group">
                <button id="alignLeft" class="btn btn-light btn-toggle">
                  L
                </button>
                <button id="alignCenter" class="btn btn-light btn-toggle">
                  C
                </button>
                <button id="alignRight" class="btn btn-light btn-toggle">
                  R
                </button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h6>File Gambar</h6>
              <input type="file" id="imageUpload" class="form-control mb-2" />
              <h6>Komponen</h6>
              <ul class="list-group" id="designList"></ul>
              <button id="clearCanvas" class="btn btn-danger w-100 mt-3">
                Hapus Semua
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-9 position-relative">
          <canvas
            id="tshirtCanvas"
            width="600"
            height="600"
            class="canvas-container"
          ></canvas>
          <div id="rulerX" class="ruler"></div>
          <div id="rulerY" class="ruler"></div>
          <div
            id="lineX"
            class="ruler-line"
            style="height: 1px; width: 600px"
          ></div>
          <div
            id="lineY"
            class="ruler-line"
            style="width: 1px; height: 600px"
          ></div>
        </div>
      </div>
    </div>

    <!-- Font Modal -->
    <div class="modal fade" id="fontModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5>Pilih Font</h5>
            <button data-bs-dismiss="modal" class="btn-close"></button>
          </div>
          <div class="modal-body">
            <input
              id="fontSearch"
              class="form-control mb-3"
              placeholder="Cari font..."
            />
            <div class="row" id="fontList"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const canvas = new fabric.Canvas("tshirtCanvas", {
        preserveObjectStacking: true,
        selection: true,
      });
      canvas.setBackgroundImage(
        "image/product4.jpeg",
        canvas.renderAll.bind(canvas),
        {
          scaleX: 600 / 800,
          scaleY: 600 / 800,
        }
      );

      const fontSizeSelect = document.getElementById("fontSize");
      for (let i = 10; i <= 64; i += 2) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${i}px`;
        fontSizeSelect.appendChild(option);
      }

      let currentFont = "Arial";
      let fontsList = [];
      const apiKey = "AIzaSyBbHsIzkkLsTKLNRcomvRlw-qZqWeC91OU";

      fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${apiKey}`)
        .then((r) => r.json())
        .then((d) => {
          fontsList = d.items.map((i) => i.family);
          renderFonts(fontsList);
        });

      function renderFonts(arr) {
        const container = document.getElementById("fontList");
        container.innerHTML = "";
        arr.forEach((f) => {
          const col = document.createElement("div");
          col.className = "col-md-4 mb-2";
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-secondary w-100 font-preview";
          btn.textContent = f;
          btn.style.fontFamily = f;
          btn.onclick = () => {
            currentFont = f;
            loadFont(f);
            const txt = new fabric.Textbox("Teks Baru", {
              left: 100,
              top: 100,
              fontFamily: f,
              fontSize: parseInt(document.getElementById("fontSize").value),
              fill: document.getElementById("textColor").value,
              backgroundColor: document.getElementById("bgTransparent").checked
                ? ""
                : document.getElementById("textBgColor").value,
            });
            canvas.add(txt).setActiveObject(txt);
            updateList();
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("fontModal")
            );
            modal.hide();
          };
          col.appendChild(btn);
          container.appendChild(col);
        });
      }

      document.getElementById("fontSearch").oninput = (e) => {
        renderFonts(
          fontsList.filter((f) =>
            f.toLowerCase().includes(e.target.value.toLowerCase())
          )
        );
      };

      function loadFont(f) {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = `https://fonts.googleapis.com/css2?family=${f.replace(
          / /g,
          "+"
        )}&display=swap`;
        document.head.appendChild(link);
      }

      document.getElementById("textColor").onchange = (e) => {
        const o = canvas.getActiveObject();
        if (o && o.type === "textbox") {
          o.set("fill", e.target.value);
          canvas.renderAll();
        }
      };
      document.getElementById("textBgColor").onchange = (e) => {
        const o = canvas.getActiveObject();
        if (o && o.type === "textbox") {
          o.set(
            "backgroundColor",
            document.getElementById("bgTransparent").checked
              ? ""
              : e.target.value
          );
          canvas.renderAll();
        }
      };
      document.getElementById("bgTransparent").onchange = () => {
        const o = canvas.getActiveObject();
        if (o && o.type === "textbox") {
          o.set(
            "backgroundColor",
            document.getElementById("bgTransparent").checked
              ? ""
              : document.getElementById("textBgColor").value
          );
          canvas.renderAll();
        }
      };
      document.getElementById("fontSize").onchange = (e) => {
        const o = canvas.getActiveObject();
        if (o && o.type === "textbox") {
          o.set("fontSize", parseInt(e.target.value));
          canvas.renderAll();
        }
      };

      const toggleBtns = [
        "boldBtn",
        "italicBtn",
        "alignLeft",
        "alignCenter",
        "alignRight",
      ];
      toggleBtns.forEach((id) => {
        document.getElementById(id).addEventListener("click", () => {
          const btn = document.getElementById(id);
          btn.classList.toggle("active");
          const o = canvas.getActiveObject();
          if (o && o.type === "textbox") {
            if (id === "boldBtn")
              o.set(
                "fontWeight",
                btn.classList.contains("active") ? "bold" : "normal"
              );
            if (id === "italicBtn")
              o.set(
                "fontStyle",
                btn.classList.contains("active") ? "italic" : "normal"
              );
            if (id.startsWith("align")) {
              ["alignLeft", "alignCenter", "alignRight"].forEach((a) =>
                document.getElementById(a).classList.remove("active")
              );
              btn.classList.add("active");
              o.set("textAlign", id.replace("align", "").toLowerCase());
            }
            canvas.renderAll();
          }
        });
      });

      document.getElementById("imageUpload").onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
          fabric.Image.fromURL(f.target.result, (img) => {
            img.scaleToWidth(60);
            img.set("name", file.name);
            canvas.add(img);
            updateList();
          });
        };
        reader.readAsDataURL(file);
      };

      function updateList() {
        const ul = document.getElementById("designList");
        ul.innerHTML = "";
        canvas.getObjects().forEach((o) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = o.text ? `Teks: ${o.text}` : `Gambar: ${o.name}`;
          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-danger";
          btn.textContent = "Hapus";
          btn.onclick = () => {
            canvas.remove(o);
            updateList();
          };
          li.appendChild(btn);
          ul.appendChild(li);
        });
      }

      document.getElementById("clearCanvas").onclick = () => {
        canvas.clear();
        canvas.setBackgroundImage(
          "image/product4.jpeg",
          canvas.renderAll.bind(canvas),
          {
            scaleX: 600 / 800,
            scaleY: 600 / 800,
          }
        );
        updateList();
      };

      // Show coordinates and rulers during drag
      const lineX = document.getElementById("lineX");
      const lineY = document.getElementById("lineY");
      const rulerX = document.getElementById("rulerX");
      const rulerY = document.getElementById("rulerY");

      canvas.on("object:moving", (e) => {
        const { left, top } = e.target;
        lineX.style.top = `${top}px`;
        lineY.style.left = `${left}px`;
        rulerX.style.top = `${top - 15}px`;
        rulerX.style.left = `0px`;
        rulerX.innerText = `Y: ${Math.round(top)}`;
        rulerY.style.left = `${left + 5}px`;
        rulerY.style.top = `0px`;
        rulerY.innerText = `X: ${Math.round(left)}`;
        lineX.style.display =
          lineY.style.display =
          rulerX.style.display =
          rulerY.style.display =
            "block";
      });

      canvas.on("mouse:up", () => {
        lineX.style.display =
          lineY.style.display =
          rulerX.style.display =
          rulerY.style.display =
            "none";
      });
    </script>
  </body>
</html>
