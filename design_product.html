<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Desain Produk - Nama Produk</title>
    <!-- favicon -->
    <link rel="icon" href="image/icon.JPG" type="image/png" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/guideline.css" />
    <!-- Swiper CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <!-- Material Icon -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- AOS JS Fade Up/Fade Down -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
  </head>

  <!-- Preloader -->
  <div
    id="preloader"
    class="fixed inset-0 bg-white z-50 flex items-center justify-center transition-opacity duration-500"
  >
    <div
      class="w-10 h-10 border-4 border-gray-200 border-t-[#d1a86f] rounded-full animate-spin"
    ></div>
  </div>

  <body class="bg-white text-white">
    <!-- Navbar Top -->
    <nav
      class="fixed top-0 left-0 w-full h-12 px-4 md:px-10 py-3 border-b border-[#d1a86f] shadow-sm flex items-center justify-between bg-[#0f2d25] z-[1000]"
      data-aos="fade-down"
      data-aos-duration="400"
      data-aos-delay="0"
    >
      <!-- Left: Logo -->
      <a href="index.html" class="flex items-center space-x-2 z-[1001]">
        <img src="image/icon.JPG" alt="Logo" class="w-8 h-8 object-contain" />
        <span
          class="text-md font-quantify font-extrabold tracking-wide text-[#d1a86f]"
        >
          SKAWAN INDUSTRIES
        </span>
      </a>

      <!-- Right: User Info with Dropdown -->
      <div class="flex items-center space-x-2 sm:space-x-3 relative z-[1000]">
        <!-- Username -->
        <span
          class="text-sm sm:text-md font-quantify font-extrabold tracking-wide text-white truncate max-w-[100px] sm:max-w-none"
        >
          USERNAME
        </span>
        <div class="relative">
          <!-- Avatar Button -->
          <button
            id="profile-menu-btn"
            class="w-9 h-9 sm:w-10 sm:h-10 rounded-full border-2 border-[#d1a86f] overflow-hidden focus:outline-none"
          >
            <img
              src="image/usericon.jpg"
              alt="User Profile"
              class="w-full h-full object-cover cursor-pointer"
            />
          </button>

          <!-- Dropdown -->
          <div
            id="profile-menu-dropdown"
            class="hidden absolute right-0 top-full mt-3 w-52 bg-white rounded-lg shadow-xl ring-1 ring-gray-200 z-[1001]"
          >
            <a
              href="user_profile.html"
              class="flex items-center gap-3 px-4 py-3 text-sm text-gray-800 hover:bg-gray-100 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-gray-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 20h9"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 4H8m8 0v16M8 4v16"
                />
              </svg>
              Edit Profil
            </a>
            <a
              href="logout.html"
              class="flex items-center gap-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 text-red-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7"
                />
              </svg>
              Logout
            </a>
          </div>

          <!-- SCRIPT -->
          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const profileBtn = document.getElementById("profile-menu-btn");
              const dropdown = document.getElementById("profile-menu-dropdown");

              profileBtn.addEventListener("click", function (e) {
                e.stopPropagation();
                dropdown.classList.toggle("hidden");
              });

              document.addEventListener("click", function (e) {
                if (
                  !dropdown.contains(e.target) &&
                  !profileBtn.contains(e.target)
                ) {
                  dropdown.classList.add("hidden");
                }
              });
            });
          </script>
        </div>
      </div>
    </nav>

    <!-- Product Info Bar -->
    <div
      class="fixed top-12 w-full z-[999] bg-white border-b border-gray-200 shadow-sm px-4 md:px-10 pt-4 pb-8 sm:py-4 flex items-start sm:items-center justify-between"
      data-aos="fade-down"
      data-aos-duration="400"
      data-aos-delay="100"
    >
      <!-- Kiri: Tombol Back -->
      <div class="flex-shrink-0 mt-1 sm:mt-0">
        <a
          href="dashboard_user.html"
          class="font-quantify inline-flex items-center text-sm sm:text-sm text-gray-600 hover:text-black font-medium transition"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 mr-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
          Kembali
        </a>
      </div>

      <!-- Tengah: Nama Produk dan Harga -->
      <div class="absolute left-1/2 transform -translate-x-1/2 text-center">
        <h1 class="text-base sm:text-lg font-quantify font-bold text-[#0f2d25]">
          Nama Produk Kaos
        </h1>
        <span
          class="text-sm sm:text-base font-quantify font-semibold text-[#0f2d25]"
        >
          Total Harga : Rp 125.000
        </span>
      </div>
    </div>

    <!-- SECTION DESAIN PRODUK -->
    <div
      class="relative overflow-visible z-0 flex flex-col-reverse lg:flex-row gap-y-6 lg:gap-x-6 mt-[160px] px-4 mb-5 h-auto"
    >
      <!-- === PANEL DESAIN KIRI === -->
      <div
        class="w-full lg:w-80 flex-none bg-white border border-[#d1a86f] p-4 rounded-2xl shadow-lg"
      >
        <!-- Judul -->
        <div class="mb-4">
          <h2 class="text-sm font-bold text-[#0f2d25] uppercase">
            Informasi Desain
          </h2>
          <p class="text-xs italic text-gray-500">(harus diisi !!)</p>
        </div>

        <!-- Ukuran & Jumlah -->
        <div class="mb-4">
          <label class="block text-xs text-[#0f2d25] mb-2 font-quantify"
            >Pilih Ukuran Size & Jumlah</label
          >
          <div class="grid grid-cols-3 gap-4">
            <!-- Ukuran manual agar label tambahan tampil -->
            <!-- XS -->
            <div>
              <label class="block text-xs text-[#0f2d25]">XS</label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- S -->
            <div>
              <label class="block text-xs text-[#0f2d25]">S</label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- M -->
            <div>
              <label class="block text-xs text-[#0f2d25]">M</label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- L -->
            <div>
              <label class="block text-xs text-[#0f2d25]">L</label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- XL -->
            <div>
              <label class="block text-xs text-[#0f2d25]">XL</label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- 2XL -->
            <div>
              <label class="block text-xs text-[#0f2d25]">
                2XL <span class="text-[11px] text-gray-500">(+10.000Rp)</span>
              </label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- 3XL -->
            <div>
              <label class="block text-xs text-[#0f2d25]">
                3XL <span class="text-[11px] text-gray-500">(+15.000Rp)</span>
              </label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- 4XL -->
            <div>
              <label class="block text-xs text-[#0f2d25]">
                4XL <span class="text-[11px] text-gray-500">(+20.000Rp)</span>
              </label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>

            <!-- 5XL -->
            <div>
              <label class="block text-xs text-[#0f2d25]">
                5XL <span class="text-[11px] text-gray-500">(+25.000Rp)</span>
              </label>
              <input
                type="number"
                min="0"
                placeholder="0"
                class="w-full mt-1 text-center text-sm text-[#0f2d25] bg-white border border-gray-300 rounded focus:ring-[#d1a86f] focus:border-[#d1a86f] focus:outline-none"
              />
            </div>
          </div>
        </div>

        <!-- Buat Teks -->
        <div class="mb-4">
          <label class="block text-xs text-[#0f2d25] mb-2 font-quantify"
            >Tambahkan Teks pada Desainmu</label
          >
          <button
            onclick="document.getElementById('fontModal').classList.remove('hidden')"
            class="w-full bg-[#d1a86f] text-[#0f2d25] border border-[#d1a86f] rounded px-4 py-2 text-sm font-semibold hover:bg-[#c1985e] transition"
          >
            Tambah Teks
          </button>
        </div>

        <!-- Kontrol Teks -->
        <div
          class="mb-4 border border-gray-300 p-3 rounded text-xs text-[#0f2d25] bg-gray-50"
        >
          <p class="font-bold mb-2">Kontrol Teks:</p>

          <label class="text-xs">Warna Teks</label>
          <input
            type="color"
            id="textColor"
            class="w-full mb-2 h-8 cursor-pointer"
            value="#000000"
          />

          <label class="text-xs">Background Teks</label>
          <input
            type="color"
            id="textBgColor"
            class="w-full mb-2 h-8 cursor-pointer"
            value="#ffffff"
          />

          <label class="inline-flex items-center space-x-2 mb-2">
            <input
              type="checkbox"
              id="bgTransparent"
              class="accent-[#0f2d25]"
            />
            <span class="text-xs">Transparan</span>
          </label>

          <label class="text-xs">Ukuran Font</label>
          <select
            id="fontSize"
            class="w-full text-sm mb-3 border-gray-300 rounded focus:ring-[#d1a86f]"
          >
            <option value="12">12px</option>
            <option value="14">14px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
            <option value="20">20px</option>
            <option value="24">24px</option>
            <option value="28">28px</option>
          </select>

          <!-- Baris 1: B / I -->
          <div class="flex gap-2 mb-2 justify-center">
            <button
              id="boldBtn"
              class="w-10 h-10 flex items-center justify-center rounded border hover:bg-gray-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 font-bold"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  d="M13 4H6v16h8a4 4 0 000-8h-4"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button
              id="italicBtn"
              class="w-10 h-10 flex items-center justify-center rounded border hover:bg-gray-100 italic"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  d="M10 4h8M6 20h8M14 4l-4 16"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>

          <!-- Baris 2: Align -->
          <div class="flex gap-2 justify-center">
            <!-- Left -->
            <button
              id="alignLeft"
              class="w-10 h-10 flex items-center justify-center rounded border hover:bg-gray-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  d="M3 6h18M3 12h12M3 18h18"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <!-- Center -->
            <button
              id="alignCenter"
              class="w-10 h-10 flex items-center justify-center rounded border hover:bg-gray-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  d="M6 6h12M4 12h16M6 18h12"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <!-- Right -->
            <button
              id="alignRight"
              class="w-10 h-10 flex items-center justify-center rounded border hover:bg-gray-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  d="M3 6h18M9 12h12M3 18h18"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Upload Gambar -->
        <div class="mb-4">
          <label class="block text-xs text-[#0f2d25] mb-2 font-quantify"
            >Letakkan Gambar atau Icon pada Desainmu</label
          >
          <label
            for="upload-photo"
            class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-[#0f2d25] rounded cursor-pointer bg-white hover:bg-gray-50 transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-[#0f2d25] mb-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16v-4m0 0V8m0 4h10m4 4v-8a2 2 0 00-2-2H5a2 2 0 00-2 2v8m16 4H5a2 2 0 01-2-2v-1a2 2 0 012-2h14a2 2 0 012 2v1a2 2 0 01-2 2z"
              />
            </svg>
            <p class="text-sm text-[#0f2d25] font-medium">
              Klik atau drag untuk upload foto/logo
            </p>
            <p class="text-xs text-gray-500">(maks 5MB, jpg/png/svg)</p>
            <input
              id="upload-photo"
              type="file"
              class="hidden"
              accept="image/*"
            />
          </label>
        </div>

        <!-- Komponen Aktif & Aksi -->
        <div class="mt-4">
          <label class="block text-xs text-[#0f2d25] mb-2 font-quantify">
            Komponen Desain Aktif
          </label>
          <div
            id="designList"
            class="space-y-2 mb-4 max-h-48 overflow-y-auto pr-2 custom-scrollbar"
          >
            <p
              id="noComponentsMessage"
              class="text-xs text-gray-500 text-center py-4"
            >
              Belum ada komponen ditambahkan.
            </p>
          </div>

          <button
            id="clearCanvas"
            class="w-full bg-red-600 text-white rounded py-2 text-sm font-semibold hover:bg-red-700 transition"
          >
            Hapus Semua Komponen
          </button>

          <button
            id="saveDesign"
            class="w-full bg-green-600 text-white mt-2 rounded py-2 text-sm font-semibold hover:bg-green-700 transition"
          >
            Simpan Desain
          </button>
        </div>

        <style>
          .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
          }

          .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
          }

          .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
          }

          .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
          }
        </style>
      </div>

      <!-- Modal Font Picker -->
      <div
        id="fontModal"
        class="fixed inset-0 z-[1000] bg-black bg-opacity-40 hidden flex items-start justify-center px-4 pt-[20vh]"
      >
        <div
          class="relative bg-white w-full max-w-2xl sm:rounded-xl shadow-xl p-6 max-h-[90vh] overflow-y-auto"
        >
          <!-- Tombol Close -->
          <button
            onclick="document.getElementById('fontModal').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold"
          >
            ✕
          </button>

          <!-- Judul Modal -->
          <h3 class="text-lg font-bold text-[#0f2d25] mb-4">Pilih Font</h3>

          <!-- Input Pencarian -->
          <input
            type="text"
            id="fontSearch"
            placeholder="Cari font..."
            class="w-full mb-4 px-4 py-2 border border-gray-300 rounded-lg text-sm text-black focus:ring-[#d1a86f] focus:border-[#d1a86f] outline-none"
          />

          <!-- Daftar Font -->
          <div
            id="fontList"
            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 max-h-[55vh] overflow-y-auto text-black"
          >
            <!-- Font items dari JS -->
          </div>
        </div>
      </div>

      <!-- Modal Deskripsi Produk -->
      <div
        id="modalDeskripsiProduk"
        class="fixed inset-0 z-[999] bg-black bg-opacity-40 flex items-center justify-center px-4 hidden"
      >
        <div
          class="bg-white w-full max-w-md sm:rounded-xl shadow-xl p-6 relative animate-fade-in"
        >
          <button
            onclick="document.getElementById('modalDeskripsiProduk').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold"
          >
            ✕
          </button>
          <h3 class="text-lg font-bold text-[#0f2d25] font-quantify mb-4">
            Deskripsi Produk
          </h3>
          <p class="text-sm text-gray-700 leading-relaxed text-justify">
            Produk ini merupakan kaos berkualitas tinggi yang terbuat dari bahan
            katun premium, nyaman dipakai sepanjang hari. Desain minimalis namun
            elegan membuatnya cocok digunakan dalam berbagai suasana baik formal
            maupun santai.
          </p>
        </div>
      </div>

      <!-- Modal Size Chart -->
      <div
        id="modalSizeChart"
        class="fixed inset-0 z-[999] bg-black bg-opacity-40 flex items-center justify-center px-4 hidden"
      >
        <div
          class="bg-white w-full max-w-md sm:rounded-xl shadow-xl p-6 relative animate-fade-in overflow-x-auto"
        >
          <button
            onclick="document.getElementById('modalSizeChart').classList.add('hidden')"
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold"
          >
            ✕
          </button>
          <h3 class="text-lg font-bold text-[#0f2d25] font-quantify mb-4">
            Size Chart Ukuran (cm)
          </h3>
          <table class="w-full text-sm border border-[#0f2d25]">
            <thead class="bg-[#0f2d25] text-white font-semibold">
              <tr>
                <th class="px-3 py-2 border border-white">Size</th>
                <th class="px-3 py-2 border border-white">Lebar</th>
                <th class="px-3 py-2 border border-white">Panjang</th>
              </tr>
            </thead>
            <tbody class="text-[#0f2d25] text-center">
              <tr>
                <td class="border px-3 py-1">XS</td>
                <td class="border px-3 py-1">42</td>
                <td class="border px-3 py-1">61</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">S</td>
                <td class="border px-3 py-1">45</td>
                <td class="border px-3 py-1">64</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">M</td>
                <td class="border px-3 py-1">48</td>
                <td class="border px-3 py-1">67</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">L</td>
                <td class="border px-3 py-1">50</td>
                <td class="border px-3 py-1">70</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">XL</td>
                <td class="border px-3 py-1">53</td>
                <td class="border px-3 py-1">75</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">2XL</td>
                <td class="border px-3 py-1">56</td>
                <td class="border px-3 py-1">75</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">3XL</td>
                <td class="border px-3 py-1">59</td>
                <td class="border px-3 py-1">75</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">4XL</td>
                <td class="border px-3 py-1">62</td>
                <td class="border px-3 py-1">75</td>
              </tr>
              <tr>
                <td class="border px-3 py-1">5XL</td>
                <td class="border px-3 py-1">65</td>
                <td class="border px-3 py-1">75</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Area Canvas di dalam div Tailwind -->
      <div
        id="canvas-wrapper"
        class="relative w-full aspect-square /* Mobile: 1:1 ratio for more height */ md:aspect-[16/10] lg:aspect-[16/10] xl:aspect-[16/10] /* Desktop: Slightly taller than 16:9 */ md:max-w-[900px] lg:max-w-[950px] xl:max-w-[950px] /* Desktop: Specific widths */ mx-auto overflow-hidden rounded-lg shadow-lg"
      >
        <!-- 2 button -->
        <div
          class="absolute top-8 left-8 sm:top-6 sm:left-6 z-50 flex flex-col gap-2 sm:gap-4"
        >
          <!-- Icon 1 - Deskripsi Produk -->
          <div class="group relative">
            <button
              onclick="document.getElementById('modalDeskripsiProduk').classList.remove('hidden')"
              class="w-8 h-8 sm:w-12 sm:h-12 rounded-md sm:rounded-lg bg-[#d1a86f] text-[#0f2d25] flex items-center justify-center shadow hover:bg-[#c1985e] transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-4 h-4 sm:w-6 sm:h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12h6m-6 4h6M9 8h6M4 6a2 2 0 012-2h8l4 4v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"
                />
              </svg>
            </button>
            <span
              class="hidden sm:block absolute sm:left-14 sm:top-1/2 sm:-translate-y-1/2 bg-[#0f2d25] text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition duration-300 whitespace-nowrap z-50"
            >
              Deskripsi Produk
            </span>
          </div>

          <!-- Icon 2 - Size Chart -->
          <div class="group relative">
            <button
              onclick="document.getElementById('modalSizeChart').classList.remove('hidden')"
              class="w-8 h-8 sm:w-12 sm:h-12 rounded-md sm:rounded-lg bg-[#d1a86f] text-[#0f2d25] flex items-center justify-center shadow hover:bg-[#c1985e] transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
                class="w-4 h-4 sm:w-6 sm:h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"
                />
              </svg>
            </button>
            <span
              class="hidden sm:block absolute sm:left-14 sm:top-1/2 sm:-translate-y-1/2 bg-[#0f2d25] text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition duration-300 whitespace-nowrap z-50"
            >
              Size/Ukuran Chart
            </span>
          </div>
        </div>

        <!-- canvas section  -->
        <canvas id="tshirtCanvas" class="w-full h-full object-contain"></canvas>

        <!-- Panel Kontrol Interaktif -->
        <div
          class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 rounded-xl shadow-xl px-2.5 sm:px-4 py-2 sm:py-3 flex flex-nowrap justify-center items-center gap-1.5 sm:gap-2 w-full max-w-[320px] sm:max-w-[560px] z-30 overflow-x-auto"
        >
          <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
            <span class="text-[10px] sm:text-sm text-gray-700 font-medium"
              >Zoom :</span
            >
            <select
              class="appearance-none bg-white border border-gray-300 text-gray-800 text-[10px] sm:text-sm px-1.5 sm:px-3 py-0.5 sm:py-1.5 rounded focus:outline-none cursor-pointer h-6 sm:h-8"
            >
              <option>50%</option>
              <option selected>75%</option>
              <option>100%</option>
              <option>125%</option>
              <option>150%</option>
            </select>
          </div>

          <button
            class="flex-shrink-0 flex items-center gap-1 sm:gap-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 text-[10px] sm:text-sm px-1.5 sm:px-3 py-0.5 sm:py-1.5 rounded transition h-6 sm:h-8"
          >
            <svg
              class="w-3.5 h-3.5 sm:w-5 sm:h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            Depan
          </button>

          <button
            class="flex-shrink-0 flex items-center gap-1 sm:gap-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 text-[10px] sm:text-sm px-1.5 sm:px-3 py-0.5 sm:py-1.5 rounded transition h-6 sm:h-8"
          >
            <svg
              class="w-3.5 h-3.5 sm:w-5 sm:h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
            Belakang
          </button>

          <button
            id="previewButton"
            class="flex-shrink-0 flex items-center gap-1 sm:gap-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 text-[10px] sm:text-sm px-1.5 sm:px-3 py-0.5 sm:py-1.5 rounded transition h-6 sm:h-8"
          >
            <svg
              class="w-3.5 h-3.5 sm:w-5 sm:h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7s-8.268-2.943-9.542-7z"
              />
            </svg>
            Preview
          </button>
        </div>

        <!-- preview modal pop up -->
        <div
          id="previewModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 hidden"
        >
          <div
            id="previewModalContent"
            class="relative bg-white rounded-lg shadow-xl transform transition-all duration-300 opacity-0 scale-95 w-11/11 mx-auto p-0 max-w-xs /* Mobile: Smallest width */ md:max-w-sm lg:max-w-sm xl:max-w-sm /* Desktop: Small and consistent width */ mt-16 mb-8 sm:mt-20 sm:mb-12 md:mt-24 md:mb-16 /* Margins for spacing from navbar/bottom */ max-h-[75vh] md:max-h-[70vh] overflow-y-auto /* Mobile: Taller, Desktop: Shorter */"
          >
            <div class="flex justify-between items-center p-4">
              <h3 class="text-lg font-semibold flex-grow text-center">
                Preview Desain
              </h3>
              <button
                id="closeModalButton"
                class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100 transition-colors absolute top-2 right-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>

            <div class="p-4 flex justify-center items-center">
              <img
                id="designPreviewImage"
                class="max-w-full h-auto object-contain"
                src=""
                alt="Design Preview"
              />
            </div>

            <div
              class="flex justify-center gap-2 p-4 border-t bg-gray-50 rounded-b-lg"
            >
              <button
                id="frontViewButton"
                class="flex-1 px-4 py-2 bg-[#d1a86f] text-white rounded-lg hover:bg-[#a6865c] transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#d1a86f] focus:ring-opacity-50 font-medium shadow-md"
              >
                Depan
              </button>
              <button
                id="backViewButton"
                class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50 font-medium shadow-md"
              >
                Belakang
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Section -->
    <footer class="w-full bg-[#0f2d25] text-white mt-10">
      <div
        class="max-w-[1500px] mx-auto px-4 sm:px-6 md:px-12 lg:px-20 xl:px-24 py-12"
      >
        <!-- Top Section -->
        <div
          class="flex flex-col md:flex-row justify-between items-center pb-8 mb-8 border-b border-[#15453a]"
        >
          <!-- Logo and Tagline -->
          <div
            class="flex flex-col md:items-start items-center text-center md:text-left mb-4 md:mb-0"
          >
            <div class="flex items-center mb-2">
              <img
                src="image/icon.JPG"
                alt="SKAWAN INDUSTRIES Logo"
                class="w-10 h-10 rounded-full mr-3"
              />
              <h3
                class="font-quantify text-xl sm:text-2xl font-bold text-[#d1a86f]"
              >
                SKAWAN INDUSTRIES
              </h3>
            </div>
            <h6 class="text-sm text-white font-quantify">
              Start order now and get a cool design product
            </h6>
          </div>
        </div>

        <!-- Grid Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          <!-- Alamat -->
          <div class="flex flex-col items-start text-left">
            <h4 class="font-bold text-lg text-white font-quantify">Alamat</h4>
            <div class="w-12 h-1 bg-white mt-1 mb-4"></div>
            <p class="text-white mb-4 font-quantify">
              Jl. Puri Airlangga No.20 blok P, Kapasan, Sidokare, Sidoarjo,
              Sidoarjo Regency, East Java 61214
            </p>
            <!-- Wrapper Peta -->
            <div
              class="relative w-full h-0 md:h-[320px] rounded-lg overflow-hidden transition-all duration-300"
            >
              <iframe
                src="https://www.google.com/maps?q=-7.446144,112.707078&hl=es;z=14&output=embed"
                class="w-full h-full filter grayscale contrast-110 pointer-events-none hidden md:block"
                allowfullscreen
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                style="border: 0"
              ></iframe>
            </div>
          </div>

          <!-- Follow Us On -->
          <div class="flex flex-col items-start text-left">
            <h4 class="font-bold text-lg text-white font-quantify">
              Follow Us On :
            </h4>
            <div class="w-12 h-1 bg-white mt-1 mb-4"></div>
            <div class="flex flex-col space-y-4">
              <!-- WhatsApp -->
              <a
                href="https://wa.me/6289649710370"
                target="_blank"
                class="flex items-center space-x-3 group"
              >
                <div
                  class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 group-hover:bg-white/20 transition"
                >
                  <img
                    src="image/whatsapp_icon.png"
                    alt="WhatsApp"
                    class="w-5 h-5"
                  />
                </div>
                <span class="text-white font-quantify">WhatsApp</span>
              </a>

              <!-- Instagram -->
              <a
                href="https://www.instagram.com/skawanindustries?igsh=MzJqMWdwb294Mnk4"
                target="_blank"
                class="flex items-center space-x-3 group"
              >
                <div
                  class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 group-hover:bg-white/20 transition"
                >
                  <img
                    src="image/instagram_icon.png"
                    alt="Instagram"
                    class="w-5 h-5"
                  />
                </div>
                <span class="text-white font-quantify">Instagram</span>
              </a>

              <!-- Shopee -->
              <a
                href="http://shopee.co.id/skawanindustries"
                target="_blank"
                class="flex items-center space-x-3 group"
              >
                <div
                  class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 group-hover:bg-white/20 transition"
                >
                  <img
                    src="image/shopee_icon.png"
                    alt="Shopee"
                    class="w-5 h-5"
                  />
                </div>
                <span class="text-white font-quantify">Shopee</span>
              </a>
            </div>
          </div>

          <!-- Get In Touch -->
          <div class="flex flex-col items-start text-left">
            <h4 class="font-bold text-lg text-white font-quantify">
              Get In Touch With Us
            </h4>
            <div class="w-12 h-1 bg-white mt-1 mb-4"></div>
            <p class="text-white font-quantify">Phone: +62 8819 727 687</p>
            <p class="text-white mt-4 font-quantify">
              Senin–Jumat:<br />9.00 – 20.00
            </p>
            <p class="text-white mt-4 font-quantify">
              Saturday-Minggu:<br />10.00 – 17.00
            </p>
            <p class="text-white mt-4 font-quantify">
              support@skawanindustries.com
            </p>
          </div>

          <!-- Quick Links -->
          <div class="flex flex-col items-start text-left">
            <h4 class="font-bold text-lg text-white font-quantify">
              Quick Links
            </h4>
            <div class="w-12 h-1 bg-white mt-1 mb-4"></div>
            <ul class="space-y-2">
              <li>
                <a
                  href="index.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >Home Page</a
                >
              </li>
              <li>
                <a
                  href="list_product.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >category1</a
                >
              </li>
              <li>
                <a
                  href="list_product.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >category2</a
                >
              </li>
              <li>
                <a
                  href="list_product.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >category3</a
                >
              </li>
              <li>
                <a
                  href="list_product.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >category4</a
                >
              </li>
              <li>
                <a
                  href="list_product.html"
                  class="text-white hover:text-green-300 font-quantify"
                  >category5</a
                >
              </li>
            </ul>
          </div>
        </div>

        <!-- Bottom Footer -->
        <div
          class="mt-12 pt-6 border-t border-[#15453a] flex flex-col md:flex-row justify-between items-center text-sm text-white gap-4"
        >
          <!-- Left: Follow Us On -->
          <div class="flex items-center space-x-4">
            <span class="font-quantify text-white">Follow Us On:</span>

            <!-- WhatsApp -->
            <a
              href="https://wa.me/6289649710370"
              target="_blank"
              class="hover:text-green-300 transition"
            >
              <img
                src="image/whatsapp_icon.png"
                alt="WhatsApp"
                class="w-5 h-5"
              />
            </a>

            <!-- Instagram -->
            <a
              href="https://www.instagram.com/skawanindustries?igsh=MzJqMWdwb294Mnk4"
              target="_blank"
              class="hover:text-green-300 transition"
            >
              <img
                src="image/instagram_icon.png"
                alt="Instagram"
                class="w-5 h-5"
              />
            </a>
          </div>

          <!-- Center: Copyright -->
          <p class="text-center w-full md:w-auto font-quantify">
            © 2025 SKAWAN INDUSTRIES. All rights reserved.
          </p>

          <!-- Right: Kosong -->
          <div class="w-[120px] h-5 hidden md:block"></div>
        </div>
      </div>
    </footer>

    <!-- swiper js -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- AOS JS Fade Up/Fade Down -->
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();
    </script>
    <!-- tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- fabric js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <!-- custom js -->
    <script src="js/script.js"></script>
    <script>
      const canvas = new fabric.Canvas("tshirtCanvas", {
        preserveObjectStacking: true,
        selection: true,
        controlsAboveOverlay: true,
      });

      let bgImageObject = null;
      let currentView = "front"; // State for the current view (front/back)
      // Inisialisasi properti canvasWidth dan canvasHeight di sini juga untuk memastikan keberadaan properti
      const frontDesignData = { objects: [], canvasWidth: 0, canvasHeight: 0 }; // Stores serialized JSON objects for front design
      const backDesignData = { objects: [], canvasWidth: 0, canvasHeight: 0 }; // Stores serialized JSON objects for back design

      const frontImageUrl = "image/product4.jpeg";
      const backImageUrl = "image/product1.jpeg"; // Temporary back image

      // Store initial/current canvas dimensions for scaling
      let lastCanvasWidth = 0;
      let lastCanvasHeight = 0;

      // Initialize background image for the canvas
      // This function will be called initially and on resize
      const initializeCanvasAndBackground = () => {
        const canvasWrapper = document.getElementById("canvas-wrapper");
        if (!canvasWrapper) return;

        const currentWrapperWidth = canvasWrapper.clientWidth;
        const currentWrapperHeight = canvasWrapper.clientHeight;

        // Set new canvas dimensions based on wrapper
        canvas.setDimensions(
          {
            width: currentWrapperWidth,
            height: currentWrapperHeight,
          },
          { cssOnly: false }
        ); // Ensure Fabric.js internal dimensions are updated

        // Calculate scaling factor for existing objects if canvas size is changing
        let scaleFactorX = 1;
        let scaleFactorY = 1;

        // Only calculate scale factor if we have a previous size to compare
        if (lastCanvasWidth > 0 && lastCanvasHeight > 0) {
          scaleFactorX = currentWrapperWidth / lastCanvasWidth;
          scaleFactorY = currentWrapperHeight / lastCanvasHeight;
        }

        // Scale existing objects on the canvas (excluding background and guide lines)
        // This loop handles scaling when the browser window is resized
        canvas.forEachObject((obj) => {
          if (
            obj === bgImageObject ||
            obj === centerGuideLineX ||
            obj === centerGuideLineY ||
            obj === dragGuideLineX ||
            obj === dragGuideLineY ||
            obj === labelX ||
            obj === labelY
          ) {
            return;
          }

          // Apply scaling to position and dimensions
          obj.set({
            left: obj.left * scaleFactorX,
            top: obj.top * scaleFactorY,
            scaleX: obj.scaleX * scaleFactorX,
            scaleY: obj.scaleY * scaleFactorY,
          });

          // For textboxes, also scale the font size
          if (obj.type === "textbox") {
            obj.set("fontSize", obj.fontSize * scaleFactorY);
            obj.initDimensions(); // Recalculate dimensions based on new font size
          }
          obj.setCoords(); // Update object's bounding box after scaling
        });

        // Update last recorded dimensions AFTER setting new dimensions and scaling objects
        lastCanvasWidth = currentWrapperWidth;
        lastCanvasHeight = currentWrapperHeight;

        // Re-load and re-scale background image to fit new canvas size
        const currentBgImageUrl =
          currentView === "front" ? frontImageUrl : backImageUrl;
        fabric.Image.fromURL(
          currentBgImageUrl,
          (img) => {
            bgImageObject = img;
            const canvasWidth = canvas.getWidth();
            const canvasHeight = canvas.getHeight();
            const imgAspectRatio = img.width / img.height;
            const canvasAspectRatio = canvasWidth / canvasHeight;

            let scale;
            // Scale to fit within the canvas, prioritizing fitting fully
            if (imgAspectRatio > canvasAspectRatio) {
              scale = canvasHeight / img.height; // If image is wider, scale by height
            } else {
              scale = canvasWidth / img.width; // If image is taller, scale by width
            }

            img.scale(scale);

            // Center the background image
            const centerX = (canvasWidth - img.width * scale) / 2;
            const centerY = (canvasHeight - img.height * scale) / 2;

            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
              left: centerX,
              top: centerY,
              originX: "left",
              originY: "top",
              selectable: false,
              evented: false,
            });

            // Update guide lines positions after canvas resize
            centerGuideLineX.set({
              x1: 0,
              y1: canvas.getHeight() / 2,
              x2: canvas.getWidth(),
              y2: canvas.getHeight() / 2,
            });
            centerGuideLineY.set({
              x1: canvas.getWidth() / 2,
              y1: 0,
              x2: canvas.getWidth() / 2,
              y2: canvas.getHeight(),
            });
            canvas.renderAll();
          },
          { crossOrigin: "anonymous" } // Add crossOrigin for images from external sources
        );
      };

      // Guide lines (always visible and non-interactive) - initialize them after canvas is ready
      const centerGuideLineX = new fabric.Line([0, 0, 0, 0], {
        stroke: "#dc2626", // red
        strokeWidth: 1,
        selectable: false,
        evented: false,
        hasControls: false,
        visible: true,
        originX: "left",
        originY: "top",
      });

      const centerGuideLineY = new fabric.Line([0, 0, 0, 0], {
        stroke: "#dc2626", // red
        strokeWidth: 1,
        selectable: false,
        evented: false,
        hasControls: false,
        visible: true,
        originX: "left",
        originY: "top",
      });

      canvas.add(centerGuideLineX);
      canvas.add(centerGuideLineY);

      // Drag guide lines (only appear during dragging and non-interactive)
      const dragGuideLineX = new fabric.Line([0, 0, 0, 0], {
        stroke: "#10B981", // Green for drag guide lines
        strokeWidth: 1,
        selectable: false,
        evented: false,
        hasControls: false,
        visible: false,
      });

      const dragGuideLineY = new fabric.Line([0, 0, 0, 0], {
        stroke: "#10B981", // Green for drag guide lines
        strokeWidth: 1,
        selectable: false,
        evented: false,
        hasControls: false,
        visible: false,
      });

      canvas.add(dragGuideLineX);
      canvas.add(dragGuideLineY);

      // Coordinate labels (only appear during dragging and non-interactive)
      const labelX = new fabric.Text("", {
        fontSize: 12,
        fill: "#10B981",
        backgroundColor: "rgba(255,255,255,0.8)",
        originX: "left",
        originY: "top",
        selectable: false,
        evented: false,
        hasControls: false,
        visible: false,
      });

      const labelY = new fabric.Text("", {
        fontSize: 12,
        fill: "#10B981",
        backgroundColor: "rgba(255,255,255,0.8)",
        originX: "left",
        originY: "top",
        selectable: false,
        evented: false,
        hasControls: false,
        visible: false,
      });

      canvas.add(labelX);
      canvas.add(labelY);

      // Initial call to set up canvas and background
      document.addEventListener(
        "DOMContentLoaded",
        initializeCanvasAndBackground
      );
      window.addEventListener("resize", initializeCanvasAndBackground);
    </script>
    <script>
      // Function to set the background image of the canvas
      const setBackgroundImage = (imgUrl) => {
        fabric.Image.fromURL(
          imgUrl,
          (img) => {
            bgImageObject = img;
            const canvasWidth = canvas.getWidth();
            const canvasHeight = canvas.getHeight();
            const imgAspectRatio = img.width / img.height;
            const canvasAspectRatio = canvasWidth / canvasHeight;

            let scale;
            if (imgAspectRatio > canvasAspectRatio) {
              scale = canvasHeight / img.height;
            } else {
              scale = canvasWidth / img.width;
            }

            img.scale(scale);

            const centerX = (canvasWidth - img.width * scale) / 2;
            const centerY = (canvasHeight - img.height * scale) / 2;

            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
              left: centerX,
              top: centerY,
              originX: "left",
              originY: "top",
              selectable: false,
              evented: false,
            });
            canvas.renderAll(); // Ensure canvas renders after background is set
          },
          { crossOrigin: "anonymous" }
        ); // Add crossOrigin
      };

      // Function to save current design objects to specified data storage
      function saveCurrentDesignToData(designStorage) {
        // Store the current canvas dimensions along with the design objects
        designStorage.canvasWidth = canvas.getWidth();
        designStorage.canvasHeight = canvas.getHeight();

        // Fabric.js toJSON() includes originX/Y and fontFamily by default for most objects
        designStorage.objects = canvas
          .getObjects()
          .filter(
            (obj) =>
              obj !== bgImageObject &&
              obj !== centerGuideLineX &&
              obj !== centerGuideLineY &&
              obj !== dragGuideLineX &&
              obj !== dragGuideLineY &&
              obj !== labelX &&
              obj !== labelY
          )
          .map((obj) =>
            obj.toJSON([
              "originX",
              "originY",
              "fontFamily",
              "textAlign",
              "fontWeight",
              "fontStyle",
              "backgroundColor",
              "padding",
            ])
          ); // Ensure these properties are explicitly saved
        console.log(`Saved design for ${currentView}:`, designStorage);
      }

      // Function to clear design objects from the canvas (excluding background and guide lines)
      function clearCanvasObjects() {
        const objectsToRemove = canvas.getObjects().filter((obj) => {
          return (
            obj !== bgImageObject &&
            obj !== centerGuideLineX &&
            obj !== centerGuideLineY &&
            obj !== dragGuideLineX &&
            obj !== dragGuideLineY &&
            obj !== labelX &&
            obj !== labelY
          );
        });

        objectsToRemove.forEach((obj) => {
          canvas.remove(obj);
        });
        canvas.discardActiveObject();
        canvas.renderAll();
      }

      // Function to load design objects from specified data storage
      function loadDesignFromData(designStorage) {
        clearCanvasObjects(); // Clear existing objects before loading new ones

        fabric.util.enlivenObjects(
          designStorage.objects,
          function (enlivenedObjects) {
            // Get the current canvas dimensions
            const currentCanvasWidth = canvas.getWidth();
            const currentCanvasHeight = canvas.getHeight();

            // Get the canvas dimensions from when the design was saved
            // Fallback to current dimensions if not stored (e.g., initial load without saved data)
            const savedCanvasWidth =
              designStorage.canvasWidth || currentCanvasWidth;
            const savedCanvasHeight =
              designStorage.canvasHeight || currentCanvasHeight;

            // Calculate scaling factors
            const scaleFactorX = currentCanvasWidth / savedCanvasWidth;
            const scaleFactorY = currentCanvasHeight / savedCanvasHeight;

            enlivenedObjects.forEach((obj) => {
              // Load fonts dynamically if they are textboxes
              if (obj.type === "textbox" && obj.fontFamily) {
                const font = obj.fontFamily;
                const fontId = `font-link-${font.replace(/[^a-zA-Z0-9]/g, "")}`;
                if (!document.getElementById(fontId)) {
                  const link = document.createElement("link");
                  link.id = fontId;
                  link.rel = "stylesheet";
                  link.href = `https://fonts.googleapis.com/css2?family=${font.replace(
                    / /g,
                    "+"
                  )}&display=swap`;
                  document.head.appendChild(link);
                }
              }

              // Apply scaling to the object properties
              obj.set({
                left: obj.left * scaleFactorX,
                top: obj.top * scaleFactorY,
                scaleX: obj.scaleX * scaleFactorX,
                scaleY: obj.scaleY * scaleFactorY,
              });

              // For textboxes, also scale the font size
              if (obj.type === "textbox") {
                obj.set("fontSize", obj.fontSize * scaleFactorY);
                obj.initDimensions(); // Recalculate textbox dimensions after font change
              }
              obj.setCoords(); // Update bounding box

              canvas.add(obj);
            });
            canvas.renderAll();
            updateDesignList();
            updateUIFromActiveObject();
          }
        );
      }

      // Function to load custom fonts from a design JSON (used for initial load from local storage)
      const loadCustomFontsFromDesign = (json) => {
        try {
          const designData = JSON.parse(json);
          if (designData && (designData.front || designData.back)) {
            const allObjects = [];
            if (designData.front && designData.front.objects) {
              allObjects.push(...designData.front.objects);
            }
            if (designData.back && designData.back.objects) {
              allObjects.push(...designData.back.objects);
            }

            allObjects.forEach((obj) => {
              if (obj.type === "textbox" && obj.fontFamily) {
                const font = obj.fontFamily;
                const fontId = `font-link-${font.replace(/[^a-zA-Z0-9]/g, "")}`;
                if (!document.getElementById(fontId)) {
                  const link = document.createElement("link");
                  link.id = fontId;
                  link.rel = "stylesheet";
                  link.href = `https://fonts.googleapis.com/css2?family=${font.replace(
                    / /g,
                    "+"
                  )}&display=swap`;
                  document.head.appendChild(link);
                }
              }
            });
          }
        } catch (e) {
          console.error("Error parsing JSON or loading fonts from design:", e);
        }
      };
    </script>
    <script>
      const fontSizeSelect = document.getElementById("fontSize");
      if (fontSizeSelect) {
        for (let i = 10; i <= 64; i += 2) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `${i}px`;
          fontSizeSelect.appendChild(opt);
        }
      }

      let currentFont = "Arial";
      let fontsList = [];
      const apiKey = "AIzaSyBbHsIzkkLsTKLNRcomvRlw-qZqWeC91OU"; // Replace with your valid Google Fonts API Key

      fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${apiKey}`)
        .then((r) => r.json())
        .then((d) => {
          fontsList = d.items.map((i) => i.family);
          renderFonts(fontsList);
        })
        .catch((error) => console.error("Error fetching fonts:", error));

      function renderFonts(arr) {
        const container = document.getElementById("fontList");
        if (!container) return;

        container.innerHTML = "";

        arr.slice(0, 50).forEach((font) => {
          const fontId = `font-link-${font.replace(/[^a-zA-Z0-9]/g, "")}`;
          if (!document.getElementById(fontId)) {
            const link = document.createElement("link");
            link.id = fontId;
            link.rel = "stylesheet";
            link.href = `https://fonts.googleapis.com/css2?family=${font.replace(
              / /g,
              "+"
            )}&display=swap`;
            document.head.appendChild(link);
          }

          const div = document.createElement("div");
          div.className =
            "border p-2 rounded text-center text-sm cursor-pointer hover:bg-gray-100 mb-1 font-list-item";
          div.textContent = font;
          div.style.fontFamily = font;
          div.onclick = () => {
            currentFont = font;
            const fontModal = document.getElementById("fontModal");

            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === "textbox") {
              activeObject.set({ fontFamily: currentFont });
              activeObject.initDimensions(); // Crucial for textbox to re-render with new font
              canvas.renderAll();
              updateUIFromActiveObject();
              saveDesignAutomatically(); // Autosave after font change
            } else {
              addTextToCanvas(currentFont);
            }

            if (fontModal) {
              fontModal.classList.add("hidden");
            }
          };
          container.appendChild(div);
        });
      }

      const fontSearchInput = document.getElementById("fontSearch");
      if (fontSearchInput) {
        fontSearchInput.oninput = (e) => {
          const q = e.target.value.toLowerCase();
          renderFonts(fontsList.filter((f) => f.toLowerCase().includes(q)));
        };
      }
    </script>
    <script>
      function addTextToCanvas(font = "Arial") {
        const textColorInput = document.getElementById("textColor");
        const fontSizeInput = document.getElementById("fontSize");
        const bgTransparentCheckbox = document.getElementById("bgTransparent");
        const textBgColorInput = document.getElementById("textBgColor");

        const text = new fabric.Textbox("Teks Baru", {
          left: canvas.getWidth() / 2, // Center new text horizontally
          top: canvas.getHeight() / 2, // Center new text vertically
          fontFamily: font,
          fontSize: parseInt(fontSizeInput ? fontSizeInput.value : 16),
          fill: textColorInput ? textColorInput.value : "#000000",
          backgroundColor:
            bgTransparentCheckbox && bgTransparentCheckbox.checked
              ? ""
              : textBgColorInput
              ? textBgColorInput.value
              : "#ffffff",
          fontWeight: "normal",
          fontStyle: "normal",
          textAlign: "left",
          selectable: true,
          evented: true,
          hasControls: true,
          hasBorders: true,
          cornerColor: "#d1a86f",
          cornerSize: 10,
          transparentCorners: false,
          padding: 5,
          originX: "center", // Set origin to center for consistent positioning
          originY: "center",
        });
        canvas.add(text).setActiveObject(text);
        canvas.renderAll();
        updateDesignList();
        saveDesignAutomatically(); // Autosave after adding new object
      }

      const addTextButton = document.getElementById("addTextButton");
      if (addTextButton) {
        addTextButton.addEventListener("click", () =>
          addTextToCanvas(currentFont)
        );
      }

      const uploadPhotoInput = document.getElementById("upload-photo");
      if (uploadPhotoInput) {
        uploadPhotoInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (f) => {
            fabric.Image.fromURL(
              f.target.result,
              (img) => {
                img.set({
                  left: canvas.getWidth() / 2, // Center new image horizontally
                  top: canvas.getHeight() / 2, // Center new image vertically
                  selectable: true,
                  evented: true,
                  hasControls: true,
                  hasBorders: true,
                  cornerColor: "#d1a86f",
                  cornerSize: 10,
                  transparentCorners: false,
                  padding: 5,
                  originX: "center", // Set origin to center for consistent positioning
                  originY: "center",
                });

                // Scale newly added image to a reasonable default size (e.g., 25% of the smaller canvas dimension)
                const maxDim = Math.max(img.width, img.height);
                const canvasMinDim = Math.min(
                  canvas.getWidth(),
                  canvas.getHeight()
                ); // Use min to ensure it fits in either dimension
                const scaleFactor = (canvasMinDim * 0.25) / maxDim;
                img.scale(scaleFactor);

                canvas.add(img).setActiveObject(img);
                canvas.renderAll();
                updateDesignList();
                saveDesignAutomatically(); // Autosave after adding new object
              },
              { crossOrigin: "anonymous" }
            ); // Add crossOrigin
          };
          reader.readAsDataURL(file);
          e.target.value = "";
        };
      }

      // Function to update UI from active object
      function updateUIFromActiveObject() {
        const o = canvas.getActiveObject();
        const textColor = document.getElementById("textColor");
        const fontSize = document.getElementById("fontSize");
        const textBgColor = document.getElementById("textBgColor");
        const bgTransparent = document.getElementById("bgTransparent");
        const boldBtn = document.getElementById("boldBtn");
        const italicBtn = document.getElementById("italicBtn");
        const alignLeft = document.getElementById("alignLeft");
        const alignCenter = document.getElementById("alignCenter");
        const alignRight = document.getElementById("alignRight");

        if (!o || o.type !== "textbox") {
          if (textColor) textColor.value = "#000000";
          if (fontSize) fontSize.value = "16";
          if (textBgColor) textBgColor.value = "#ffffff";
          if (bgTransparent) bgTransparent.checked = false;

          [boldBtn, italicBtn, alignLeft, alignCenter, alignRight].forEach(
            (btn) => {
              if (btn) btn.classList.remove("bg-gray-300");
            }
          );
          return;
        }

        if (textColor) textColor.value = o.fill || "#000000";
        if (fontSize) fontSize.value = o.fontSize || 16;
        if (textBgColor) textBgColor.value = o.backgroundColor || "#ffffff";
        if (bgTransparent) bgTransparent.checked = !o.backgroundColor;

        [boldBtn, italicBtn].forEach((btn) => {
          if (btn) btn.classList.remove("bg-gray-300");
        });
        if (boldBtn && o.fontWeight === "bold")
          boldBtn.classList.add("bg-gray-300");
        if (italicBtn && o.fontStyle === "italic")
          italicBtn.classList.add("bg-gray-300");

        [alignLeft, alignCenter, alignRight].forEach((btn) => {
          if (btn) btn.classList.remove("bg-gray-300");
        });
        const alignId =
          "align" + o.textAlign.charAt(0).toUpperCase() + o.textAlign.slice(1);
        const activeAlignBtn = document.getElementById(alignId);
        if (activeAlignBtn) activeAlignBtn.classList.add("bg-gray-300");
      }

      canvas.on("selection:created", updateUIFromActiveObject);
      canvas.on("selection:updated", updateUIFromActiveObject);
      canvas.on("object:modified", updateUIFromActiveObject);
      canvas.on("selection:cleared", updateUIFromActiveObject);

      // Function to update active text properties
      function updateActiveText(prop, val) {
        const o = canvas.getActiveObject();
        if (o && o.type === "textbox") {
          o.set(prop, val);
          if (prop === "fontSize") {
            // Recalculate dimensions if font size changes
            o.initDimensions();
          }
          canvas.renderAll();
          updateUIFromActiveObject();
          saveDesignAutomatically(); // Autosave after text property change
        }
      }

      const textColorInput = document.getElementById("textColor");
      if (textColorInput) {
        textColorInput.onchange = (e) =>
          updateActiveText("fill", e.target.value);
      }

      const textBgColorInput = document.getElementById("textBgColor");
      const bgTransparentCheckbox = document.getElementById("bgTransparent");

      if (textBgColorInput) {
        textBgColorInput.onchange = (e) => {
          const v =
            bgTransparentCheckbox && bgTransparentCheckbox.checked
              ? ""
              : e.target.value;
          updateActiveText("backgroundColor", v);
        };
      }

      if (bgTransparentCheckbox) {
        bgTransparentCheckbox.onchange = () => {
          const val = bgTransparentCheckbox.checked
            ? ""
            : textBgColorInput
            ? textBgColorInput.value
            : "#ffffff";
          updateActiveText("backgroundColor", val);
        };
      }

      const fontSizeInput = document.getElementById("fontSize");
      if (fontSizeInput) {
        fontSizeInput.onchange = (e) =>
          updateActiveText("fontSize", parseInt(e.target.value));
      }

      const boldBtn = document.getElementById("boldBtn");
      if (boldBtn) {
        boldBtn.onclick = () => {
          const o = canvas.getActiveObject();
          if (o && o.type === "textbox") {
            const isBold = o.fontWeight === "bold";
            o.set("fontWeight", isBold ? "normal" : "bold");
            o.initDimensions(); // Recalculate dimensions
            canvas.renderAll();
            updateUIFromActiveObject();
            saveDesignAutomatically(); // Autosave
          }
        };
      }

      const italicBtn = document.getElementById("italicBtn");
      if (italicBtn) {
        italicBtn.onclick = () => {
          const o = canvas.getActiveObject();
          if (o && o.type === "textbox") {
            const isItalic = o.fontStyle === "italic";
            o.set("fontStyle", isItalic ? "normal" : "italic");
            o.initDimensions(); // Recalculate dimensions
            canvas.renderAll();
            updateUIFromActiveObject();
            saveDesignAutomatically(); // Autosave
          }
        };
      }

      ["alignLeft", "alignCenter", "alignRight"].forEach((id) => {
        const alignButton = document.getElementById(id);
        if (alignButton) {
          alignButton.onclick = () => {
            const o = canvas.getActiveObject();
            if (o && o.type === "textbox") {
              o.set("textAlign", id.replace("align", "").toLowerCase());
              o.initDimensions(); // Recalculate dimensions
              canvas.renderAll();
              updateUIFromActiveObject();
              saveDesignAutomatically(); // Autosave
            }
          };
        }
      });
    </script>
    <script>
      function updateDesignList() {
        const designListContainer = document.getElementById("designList");
        const noComponentsMessage = document.getElementById(
          "noComponentsMessage"
        );
        if (!designListContainer || !noComponentsMessage) return;

        // Clear all child elements from designListContainer EXCEPT noComponentsMessage
        // Create a temporary array of children to avoid issues with live HTMLCollection
        Array.from(designListContainer.children).forEach((child) => {
          if (child && child.id !== "noComponentsMessage") {
            designListContainer.removeChild(child);
          }
        });

        let hasComponents = false;

        // Filter drawable objects based on currentView
        const currentDesignObjects = (
          currentView === "front" ? frontDesignData : backDesignData
        ).objects;

        if (currentDesignObjects.length > 0) {
          hasComponents = true;
          const fragment = document.createDocumentFragment();
          currentDesignObjects.forEach((objData, i) => {
            // Use objData from storage
            const componentCard = document.createElement("div");
            componentCard.className =
              "flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3 shadow-sm mb-2";

            const componentName = document.createElement("span");
            componentName.className =
              "text-sm font-medium text-[#0f2d25] truncate";
            componentName.textContent =
              objData.type === "textbox"
                ? `Teks: "${
                    objData.text.length > 20
                      ? objData.text.substring(0, 17) + "..."
                      : objData.text
                  }"` // Truncate long text
                : `Gambar ${i + 1}`;

            const delBtn = document.createElement("button");
            delBtn.className =
              "p-1 rounded-full text-red-500 hover:bg-red-100 hover:text-red-700 transition flex items-center justify-center";

            delBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            `;

            delBtn.onclick = () => {
              const currentData =
                currentView === "front" ? frontDesignData : backDesignData;

              // Find the actual Fabric.js object on the canvas that corresponds to objData
              // We'll use a more robust comparison by checking type and approximate position/scale
              const objectOnCanvas = canvas.getObjects().find((obj) => {
                if (
                  obj === bgImageObject ||
                  obj === centerGuideLineX ||
                  obj === centerGuideLineY ||
                  obj === dragGuideLineX ||
                  obj === dragGuideLineY ||
                  obj === labelX ||
                  obj === labelY
                ) {
                  return false;
                }

                // Compare properties that uniquely identify the object
                if (obj.type === objData.type) {
                  if (obj.type === "textbox") {
                    return (
                      obj.text === objData.text &&
                      obj.fontFamily === objData.fontFamily &&
                      Math.abs(obj.left - objData.left) < 0.1 && // Use very small tolerance for precision
                      Math.abs(obj.top - objData.top) < 0.1 &&
                      Math.abs(obj.scaleX - objData.scaleX) < 0.01 &&
                      Math.abs(obj.scaleY - objData.scaleY) < 0.01
                    );
                  } else if (obj.type === "image") {
                    return (
                      obj.getSrc() === objData.src &&
                      Math.abs(obj.left - objData.left) < 0.1 &&
                      Math.abs(obj.top - objData.top) < 0.1 &&
                      Math.abs(obj.scaleX - objData.scaleX) < 0.01 &&
                      Math.abs(obj.scaleY - objData.scaleY) < 0.01
                    );
                  }
                }
                return false;
              });

              if (objectOnCanvas) {
                canvas.remove(objectOnCanvas); // Remove from canvas
                // Remove from storage array
                currentData.objects = currentData.objects.filter((item) => {
                  // Keep items that are NOT the one we just removed
                  if (item.type === objData.type) {
                    if (item.type === "textbox") {
                      return !(
                        item.text === objData.text &&
                        item.fontFamily === objData.fontFamily &&
                        Math.abs(item.left - objData.left) < 0.1 &&
                        Math.abs(item.top - objData.top) < 0.1 &&
                        Math.abs(item.scaleX - objData.scaleX) < 0.01 &&
                        Math.abs(item.scaleY - objData.scaleY) < 0.01
                      );
                    } else if (item.type === "image") {
                      return !(
                        item.src === objData.src &&
                        Math.abs(item.left - objData.left) < 0.1 &&
                        Math.abs(item.top - objData.top) < 0.1 &&
                        Math.abs(item.scaleX - objData.scaleX) < 0.01 &&
                        Math.abs(item.scaleY - objData.scaleY) < 0.01
                      );
                    }
                  }
                  return true; // Keep other objects
                });
                canvas.discardActiveObject();
                canvas.renderAll();
                saveDesignAutomatically(); // Autosave after deletion
              } else {
                console.warn(
                  "Object not found on canvas or in design list data for deletion."
                );
                // If the object isn't found on canvas (perhaps due to a previous bug or desync),
                // still try to remove it from the data to keep lists consistent.
                currentData.objects = currentData.objects.filter((item) => {
                  // Similar comparison logic as above
                  if (item.type === objData.type) {
                    if (item.type === "textbox") {
                      return !(
                        item.text === objData.text &&
                        item.fontFamily === objData.fontFamily &&
                        Math.abs(item.left - objData.left) < 0.1 &&
                        Math.abs(item.top - objData.top) < 0.1 &&
                        Math.abs(item.scaleX - objData.scaleX) < 0.01 &&
                        Math.abs(item.scaleY - objData.scaleY) < 0.01
                      );
                    } else if (item.type === "image") {
                      return !(
                        item.src === objData.src &&
                        Math.abs(item.left - objData.left) < 0.1 &&
                        Math.abs(item.top - objData.top) < 0.1 &&
                        Math.abs(item.scaleX - objData.scaleX) < 0.01 &&
                        Math.abs(item.scaleY - objData.scaleY) < 0.01
                      );
                    }
                  }
                  return true;
                });
                saveDesignAutomatically(); // Autosave even if removed only from data
              }
              updateDesignList();
              updateUIFromActiveObject();
            };

            componentCard.appendChild(componentName);
            componentCard.appendChild(delBtn);
            fragment.appendChild(componentCard);
          });
          designListContainer.appendChild(fragment);
        }

        if (!hasComponents) {
          noComponentsMessage.classList.remove("hidden");
        } else {
          noComponentsMessage.classList.add("hidden");
        }
      }

      const saveDesignButton = document.getElementById("saveDesign");
      if (saveDesignButton) {
        saveDesignButton.onclick = () => {
          // Save current view's design before saving to localStorage
          saveCurrentDesignToData(
            currentView === "front" ? frontDesignData : backDesignData
          );

          // Combine data from both sides for localStorage
          const fullDesignData = {
            front: frontDesignData, // Store full data objects (including canvas dimensions)
            back: backDesignData, // Store full data objects
          };

          dragGuideLineX.set("visible", false);
          dragGuideLineY.set("visible", false);
          labelX.set("visible", false);
          labelY.set("visible", false);
          canvas.renderAll();

          const json = JSON.stringify(fullDesignData);
          localStorage.setItem("kaosDesign", json);
          window.location.href = "preview_product.html";
        };
      }

      // --- AUTOSAVE FUNCTIONALITY ---
      // Function to save current design to localStorage automatically
      function saveDesignAutomatically() {
        // Get current design data for the active view
        const currentDesignDataStorage =
          currentView === "front" ? frontDesignData : backDesignData;
        saveCurrentDesignToData(currentDesignDataStorage);

        // Get the other side's data to ensure both are up-to-date for full save
        const otherDesignDataStorage =
          currentView === "front" ? backDesignData : frontDesignData;
        // Note: We are not explicitly calling saveCurrentDesignToData for the other side here
        // as its data should have been saved when switching views.
        // If a user never switches, the other side will remain empty or with old data.
        // For full robustness, you might periodically save both or ensure switch logic is strict.

        const fullDesignData = {
          front: frontDesignData,
          back: backDesignData,
        };

        localStorage.setItem("kaosDesign", JSON.stringify(fullDesignData));
        // console.log("Design autosaved!");
      }

      const clearCanvasButton = document.getElementById("clearCanvas");
      if (clearCanvasButton) {
        clearCanvasButton.onclick = () => {
          // Clear only design objects from the current view
          clearCanvasObjects();

          if (currentView === "front") {
            frontDesignData.objects = [];
            frontDesignData.canvasWidth = 0; // Reset dimensions
            frontDesignData.canvasHeight = 0;
          } else {
            backDesignData.objects = [];
            backDesignData.canvasWidth = 0; // Reset dimensions
            backDesignData.canvasHeight = 0;
          }

          canvas.discardActiveObject();
          canvas.renderAll();
          updateDesignList();
          updateUIFromActiveObject();
          saveDesignAutomatically(); // Autosave after clearing canvas
        };
      }
    </script>
    <script>
      let isDragging = false;
      let lastPosX;
      let lastPosY;

      // Function to apply zoom level
      const applyZoom = (selectedPercentage) => {
        const zoomLevel = selectedPercentage / 100;

        const viewportCenterX = canvas.width / 2;
        const viewportCenterY = canvas.height / 2;

        const newVpt = [
          zoomLevel,
          0,
          0,
          zoomLevel,
          viewportCenterX - viewportCenterX * zoomLevel,
          viewportCenterY - viewportCenterY * zoomLevel,
        ];

        canvas.setViewportTransform(newVpt);
        canvas.setZoom(zoomLevel);

        // Ensure background image and guide lines are also updated
        if (bgImageObject) {
          const currentCanvasWidth = canvas.getWidth();
          const currentCanvasHeight = canvas.getHeight();
          const imgAspectRatio = bgImageObject.width / bgImageObject.height;
          const canvasAspectRatio = currentCanvasWidth / currentCanvasHeight;

          let currentScale;
          if (imgAspectRatio > canvasAspectRatio) {
            currentScale = currentCanvasHeight / bgImageObject.height;
          } else {
            currentScale = currentCanvasWidth / bgImageObject.width;
          }

          const scaledWidth = bgImageObject.width * currentScale;
          const scaledHeight = bgImageObject.height * currentScale;

          const currentCenterX = (currentCanvasWidth - scaledWidth) / 2;
          const currentCenterY = (currentCanvasHeight - scaledHeight) / 2;

          bgImageObject.set({
            left: currentCenterX,
            top: currentCenterY,
            scaleX: currentScale,
            scaleY: currentScale,
          });
        }

        centerGuideLineX.set({
          x1: 0,
          y1: canvas.getHeight() / 2,
          x2: canvas.getWidth(),
          y2: canvas.getHeight() / 2,
        });
        centerGuideLineY.set({
          x1: canvas.getWidth() / 2,
          y1: 0,
          x2: canvas.getWidth() / 2,
          y2: canvas.getHeight(),
        });

        canvas.renderAll();
      };

      // --- Zoom functionality ---
      const zoomSelect = document.querySelector(
        ".flex.items-center.gap-1.sm\\:gap-2.flex-shrink-0 > select"
      );
      if (zoomSelect) {
        zoomSelect.addEventListener("change", (e) => {
          const selectedPercentage = parseInt(e.target.value.replace("%", ""));
          applyZoom(selectedPercentage);
        });
      }

      // --- Pan (drag) Canvas functionality ---
      canvas.on("mouse:down", function (opt) {
        const evt = opt.e;
        if (
          !canvas.getActiveObject() &&
          opt.target === null &&
          canvas.getZoom() > 1.0
        ) {
          isDragging = true;
          canvas.selection = false;
          lastPosX = evt.clientX;
          lastPosY = evt.clientY;
          canvas.setCursor("grab");
        }
      });

      canvas.on("mouse:move", function (opt) {
        if (isDragging) {
          const evt = opt.e;
          const vpt = this.viewportTransform;
          vpt[4] += evt.clientX - lastPosX;
          vpt[5] += evt.clientY - lastPosY;
          this.requestRenderAll();
          lastPosX = evt.clientX;
          lastPosY = evt.clientY;
          canvas.setCursor("grabbing");
        }
      });

      canvas.on("mouse:up", function (opt) {
        isDragging = false;
        canvas.selection = true;
        canvas.setCursor("default");
      });

      // --- Switch Front/Back Shirt View (Bottom Panel) ---
      const panelFrontViewButton = document.querySelector(
        ".flex-shrink-0.flex.items-center.gap-1.sm\\:gap-2.bg-white.border.border-gray-300.hover\\:bg-gray-100.text-gray-800.text-\\[10px\\].sm\\:text-sm.px-1\\.5.sm\\:px-3.py-0\\.5.sm\\:py-1\\.5.rounded.transition.h-6.sm\\:h-8:nth-of-type(1)"
      ); // Get "Front" button
      const panelBackViewButton = document.querySelector(
        ".flex-shrink-0.flex.items-center.gap-1.sm\\:gap-2.bg-white.border.border-gray-300.hover\\:bg-gray-100.text-gray-800.text-\\[10px\\].sm\\:text-sm.px-1\\.5.sm\\:px-3.py-0\\.5.sm\\:py-1\\.5.rounded.transition.h-6.sm\\:h-8:nth-of-type(2)"
      ); // Get "Back" button

      if (panelFrontViewButton) {
        panelFrontViewButton.addEventListener("click", () => {
          if (currentView !== "front") {
            saveCurrentDesignToData(backDesignData); // Save current (back) design
            currentView = "front";
            initializeCanvasAndBackground(); // Re-initializes canvas dims, scales existing, sets background
            loadDesignFromData(frontDesignData); // Loads objects from frontDesignData
            updateDesignList();
            updateUIFromActiveObject();
            console.log("Switched to Front View (Panel)");
            // Update active class for buttons
            panelFrontViewButton.classList.add("bg-gray-200");
            if (panelBackViewButton)
              panelBackViewButton.classList.remove("bg-gray-200");
          }
        });
      }

      if (panelBackViewButton) {
        panelBackViewButton.addEventListener("click", () => {
          if (currentView !== "back") {
            saveCurrentDesignToData(frontDesignData); // Save current (front) design
            currentView = "back";
            initializeCanvasAndBackground(); // Re-initializes canvas dims, scales existing, sets background
            loadDesignFromData(backDesignData); // Loads objects from backDesignData
            updateDesignList();
            updateUIFromActiveObject();
            console.log("Switched to Back View (Panel)");
            // Update active class for buttons
            panelBackViewButton.classList.add("bg-gray-200");
            if (panelFrontViewButton)
              panelFrontViewButton.classList.remove("bg-gray-200");
          }
        });
      }
    </script>
    <script>
      canvas.on("object:moving", function (e) {
        const obj = e.target;
        if (
          !obj ||
          obj === bgImageObject ||
          obj === centerGuideLineX ||
          obj === centerGuideLineY ||
          obj === dragGuideLineX ||
          obj === dragGuideLineY ||
          obj === labelX ||
          obj === labelY
        ) {
          dragGuideLineX.set("visible", false);
          dragGuideLineY.set("visible", false);
          labelX.set("visible", false);
          labelY.set("visible", false);
          canvas.renderAll();
          return;
        }

        const centerX = canvas.getWidth() / 2;
        const centerY = canvas.getHeight() / 2;
        const objCenter = obj.getCenterPoint();
        const tolerance = 5;

        const isCenterX = Math.abs(objCenter.x - centerX) < tolerance;
        const isCenterY = Math.abs(objCenter.y - centerY) < tolerance;

        dragGuideLineX.set({
          x1: 0,
          y1: objCenter.y,
          x2: canvas.getWidth(),
          y2: objCenter.y,
          visible: true,
          strokeWidth: isCenterY ? 2.5 : 1,
          stroke: isCenterY ? "#dc2626" : "#10B981",
        });

        dragGuideLineY.set({
          x1: objCenter.x,
          y1: 0,
          x2: objCenter.x,
          y2: canvas.getHeight(),
          visible: true,
          strokeWidth: isCenterX ? 2.5 : 1,
          stroke: isCenterX ? "#dc2626" : "#10B981",
        });

        if (isCenterX) {
          obj.set({
            left: centerX - obj.getScaledWidth() / 2,
            originX: "left", // Ensure origin is set for consistent centering
          });
        }
        if (isCenterY) {
          obj.set({
            top: centerY - obj.getScaledHeight() / 2,
            originY: "top", // Ensure origin is set for consistent centering
          });
        }

        const x = Math.round(obj.left ?? 0);
        const y = Math.round(obj.top ?? 0);

        labelX.set({
          text: `X: ${x}`,
          left: obj.left,
          top: obj.top - 20,
          visible: true,
        });

        labelY.set({
          text: `Y: ${y}`,
          left: obj.left,
          top: obj.top - 35,
          visible: true,
        });

        canvas.bringToFront(dragGuideLineX);
        canvas.bringToFront(dragGuideLineY);
        canvas.bringToFront(labelX);
        canvas.bringToFront(labelY);

        canvas.renderAll();
      });

      canvas.on("mouse:up", () => {
        dragGuideLineX.set("visible", false);
        dragGuideLineY.set("visible", false);
        labelX.set("visible", false);
        labelY.set("visible", false);
        canvas.renderAll();
      });
    </script>
    <script>
      // Function to generate a preview image for the modal (front or back)
      async function generatePreviewImageForModal(viewToPreview) {
        // Define internal rendering dimensions for the temporary canvas.
        const PREVIEW_RENDER_WIDTH = 500;
        let PREVIEW_RENDER_HEIGHT = PREVIEW_RENDER_WIDTH; // Default to square, will be updated

        const tempCanvasElement = document.createElement("canvas");

        let tempBgImageUrl =
          viewToPreview === "front" ? frontImageUrl : backImageUrl;
        let tempDataStorage =
          viewToPreview === "front" ? frontDesignData : backDesignData;

        // Load actual product image to get its natural dimensions for aspect ratio calculation
        const imgTemp = new Image();
        imgTemp.src = tempBgImageUrl;
        await new Promise((resolve) => {
          imgTemp.onload = () => {
            if (imgTemp.naturalWidth && imgTemp.naturalHeight) {
              const imageAspectRatio =
                imgTemp.naturalWidth / imgTemp.naturalHeight;
              PREVIEW_RENDER_HEIGHT = PREVIEW_RENDER_WIDTH / imageAspectRatio;
            }
            resolve();
          };
          imgTemp.onerror = resolve; // Resolve even on error to prevent hanging
        });

        const tempCanvas = new fabric.Canvas(tempCanvasElement, {
          width: PREVIEW_RENDER_WIDTH,
          height: PREVIEW_RENDER_HEIGHT,
          backgroundColor: "transparent",
          selection: false,
          interactive: false,
          renderOnAddRemove: false, // Prevents excessive rendering during load
        });

        // Load background image to the temporary canvas
        const bgImgForModal = await new Promise((resolve) => {
          fabric.Image.fromURL(
            tempBgImageUrl,
            (img) => {
              if (!img) return resolve(null);

              const imgAspectRatio = img.width / img.height;
              const canvasAspectRatio =
                tempCanvas.getWidth() / tempCanvas.getHeight();

              let scale;
              if (imgAspectRatio > canvasAspectRatio) {
                scale = tempCanvas.getHeight() / img.height;
              } else {
                scale = tempCanvas.getWidth() / img.width;
              }

              img.scale(scale);
              const centerX = (tempCanvas.getWidth() - img.width * scale) / 2;
              const centerY = (tempCanvas.getHeight() - img.height * scale) / 2;

              img.set({
                left: centerX,
                top: centerY,
                originX: "left",
                originY: "top",
                selectable: false,
                evented: false,
              });
              resolve(img);
            },
            { crossOrigin: "anonymous" }
          );
        });

        if (bgImgForModal) {
          tempCanvas.setBackgroundImage(
            bgImgForModal,
            tempCanvas.renderAll.bind(tempCanvas)
          );
        }

        // Load design objects to the temporary canvas
        const tempDataObjects = tempDataStorage.objects;
        // Gunakan dimensi kanvas yang tersimpan saat design dibuat sebagai referensi
        const savedCanvasWidth =
          tempDataStorage.canvasWidth || canvas.getWidth();
        const savedCanvasHeight =
          tempDataStorage.canvasHeight || canvas.getHeight();

        // Load fonts dynamically if they are textboxes in the design data
        if (tempDataObjects && tempDataObjects.length > 0) {
          const fontFamiliesToLoad = new Set();
          tempDataObjects.forEach((obj) => {
            if (obj.type === "textbox" && obj.fontFamily) {
              fontFamiliesToLoad.add(obj.fontFamily);
            }
          });
          const fontLoadPromises = [];
          fontFamiliesToLoad.forEach((fontFamily) => {
            const fontUrl = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(
              / /g,
              "+"
            )}&display=swap`;
            const linkId = `modal-font-link-${fontFamily.replace(
              /[^a-zA-Z0-9]/g,
              ""
            )}`;
            if (!document.getElementById(linkId)) {
              const link = document.createElement("link");
              link.id = linkId;
              link.rel = "stylesheet";
              link.href = fontUrl;
              document.head.appendChild(link);
            }
            fontLoadPromises.push(document.fonts.load(`16px "${fontFamily}"`));
          });
          await Promise.all(fontLoadPromises).catch((e) =>
            console.error("Error loading fonts for modal:", e)
          );
        }

        // After background is loaded, add design objects
        await new Promise((resolve) => {
          if (tempDataObjects && tempDataObjects.length > 0) {
            fabric.util.enlivenObjects(
              tempDataObjects,
              function (enlivenedObjects) {
                // Calculate scaling factors from the *saved design's canvas size* to the *modal preview canvas size*
                const widthScaleFactor =
                  PREVIEW_RENDER_WIDTH / savedCanvasWidth;
                const heightScaleFactor =
                  PREVIEW_RENDER_HEIGHT / savedCanvasHeight;

                enlivenedObjects.forEach((obj) => {
                  const clonedObj = fabric.util.object.clone(obj); // Clone the Fabric.js object JSON

                  clonedObj.set({
                    left: obj.left * widthScaleFactor,
                    top: obj.top * heightScaleFactor,
                    scaleX: obj.scaleX * widthScaleFactor,
                    scaleY: obj.scaleY * heightScaleFactor,
                    selectable: false, // Ensure non-interactive
                    evented: false,
                    hasControls: false,
                    hasBorders: false,
                    // Restore original originX/Y if needed, otherwise Fabric.js defaults to 'left'/'top'
                    // when enlivening unless specified in JSON. Explicitly set to avoid issues.
                    originX: obj.originX || "left",
                    originY: obj.originY || "top",
                  });
                  // For textboxes, scale font size
                  if (clonedObj.type === "textbox") {
                    clonedObj.set("fontSize", obj.fontSize * heightScaleFactor);
                    clonedObj.initDimensions(); // Recalculate dimensions for scaled font
                  }
                  tempCanvas.add(clonedObj);
                });
                tempCanvas.renderAll();
                resolve();
              }
            );
          } else {
            resolve(); // Resolve if no objects to load
          }
        });

        // Generate final image from temp canvas
        const dataURL = tempCanvas.toDataURL({
          format: "png",
          multiplier: 1.5, // Multiplier for higher quality
        });
        tempCanvas.dispose(); // Clean up temporary canvas element and Fabric.js instance
        return dataURL;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const previewButton = document.getElementById("previewButton");
        const previewModal = document.getElementById("previewModal");
        const closeModalButton = document.getElementById("closeModalButton");
        const designPreviewImage =
          document.getElementById("designPreviewImage");
        const previewModalContent = document.getElementById(
          "previewModalContent"
        );

        const modalFrontViewButton = document.getElementById(
          "modalFrontViewButton"
        ); // Changed ID for clarity
        const modalBackViewButton = document.getElementById(
          "modalBackViewButton"
        ); // Changed ID for clarity

        // Event listener to open the modal
        if (previewButton) {
          previewButton.addEventListener("click", async function () {
            // Save current view's design before opening modal to ensure latest state
            saveCurrentDesignToData(
              currentView === "front" ? frontDesignData : backDesignData
            );

            // Hide guide lines for modal preview on the main canvas
            const guideObjects = [
              centerGuideLineX,
              centerGuideLineY,
              dragGuideLineX,
              dragGuideLineY,
              labelX,
              labelY,
            ];
            guideObjects.forEach((obj) => obj.set("visible", false));
            canvas.renderAll(); // Re-render main canvas to hide guides

            const initialViewForModal = currentView;
            const dataURL = await generatePreviewImageForModal(
              initialViewForModal
            );
            designPreviewImage.src = dataURL;

            // Ensure the correct button is highlighted when opening the modal
            if (modalFrontViewButton && modalBackViewButton) {
              if (initialViewForModal === "front") {
                modalFrontViewButton.classList.add("bg-gray-200");
                modalBackViewButton.classList.remove("bg-gray-200");
              } else {
                modalBackViewButton.classList.add("bg-gray-200");
                modalFrontViewButton.classList.remove("bg-gray-200");
              }
            }

            previewModal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");

            setTimeout(() => {
              previewModalContent.classList.remove("opacity-0", "scale-95");
              previewModalContent.classList.add("opacity-100", "scale-100");
            }, 10);
          });
        }

        // Event listener for "Front" button in the modal
        if (modalFrontViewButton) {
          modalFrontViewButton.addEventListener("click", async () => {
            const dataURL = await generatePreviewImageForModal("front");
            designPreviewImage.src = dataURL;
            modalFrontViewButton.classList.add("bg-gray-200");
            if (modalBackViewButton)
              modalBackViewButton.classList.remove("bg-gray-200");
          });
        }

        // Event listener for "Back" button in the modal
        if (modalBackViewButton) {
          modalBackViewButton.addEventListener("click", async () => {
            const dataURL = await generatePreviewImageForModal("back");
            designPreviewImage.src = dataURL;
            modalBackViewButton.classList.add("bg-gray-200");
            if (modalFrontViewButton)
              modalFrontViewButton.classList.remove("bg-gray-200");
          });
        }

        // Close Modal Button Event Listener
        if (closeModalButton) {
          closeModalButton.addEventListener("click", function () {
            previewModalContent.classList.remove("opacity-100", "scale-100");
            previewModalContent.classList.add("opacity-0", "scale-95");

            previewModalContent.addEventListener(
              "transitionend",
              function handler() {
                previewModal.classList.add("hidden");
                document.body.classList.remove("overflow-hidden");
                previewModalContent.removeEventListener(
                  "transitionend",
                  handler
                );
                // Re-enable main canvas guide lines after modal closes
                centerGuideLineX.set("visible", true);
                centerGuideLineY.set("visible", true);
                canvas.renderAll();
              },
              { once: true }
            );
          });
        }

        // Close Modal when clicking outside
        if (previewModal) {
          previewModal.addEventListener("click", function (event) {
            if (event.target === previewModal) {
              previewModalContent.classList.remove("opacity-100", "scale-100");
              previewModalContent.classList.add("opacity-0", "scale-95");

              previewModalContent.addEventListener(
                "transitionend",
                function handler() {
                  previewModal.classList.add("hidden");
                  document.body.classList.remove("overflow-hidden");
                  previewModalContent.removeEventListener(
                    "transitionend",
                    handler
                  );
                  // Re-enable main canvas guide lines after modal closes
                  centerGuideLineX.set("visible", true);
                  centerGuideLineY.set("visible", true);
                  canvas.renderAll();
                },
                { once: true }
              );
            }
          });
        }

        // Close Modal with Escape key
        document.addEventListener("keydown", function (event) {
          if (
            event.key === "Escape" &&
            previewModal &&
            !previewModal.classList.contains("hidden")
          ) {
            previewModalContent.classList.remove("opacity-100", "scale-100");
            previewModalContent.classList.add("opacity-0", "scale-95");

            previewModalContent.addEventListener(
              "transitionend",
              function handler() {
                previewModal.classList.add("hidden");
                document.body.classList.remove("overflow-hidden");
                previewModalContent.removeEventListener(
                  "transitionend",
                  handler
                );
                // Re-enable main canvas guide lines after modal closes
                centerGuideLineX.set("visible", true);
                centerGuideLineY.set("visible", true);
                canvas.renderAll();
              },
              { once: true }
            );
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const savedFullDesign = localStorage.getItem("kaosDesign");
        // Penting: Panggil initializeCanvasAndBackground terlebih dahulu
        // Ini akan mengatur dimensi kanvas dan mengelola scaling awal objek kosong atau objek yang sudah ada
        initializeCanvasAndBackground();

        if (savedFullDesign) {
          try {
            const parsedDesign = JSON.parse(savedFullDesign);
            // Ensure properties exist before assigning
            if (parsedDesign.front) {
              Object.assign(frontDesignData, parsedDesign.front);
            }
            if (parsedDesign.back) {
              Object.assign(backDesignData, parsedDesign.back);
            }
            // Load the design data into the canvas.
            // loadDesignFromData akan menskalakan objek sesuai dengan currentCanvasWidth/Height
            loadDesignFromData(frontDesignData);
            currentView = "front";
            // Manually set initial active state for panel buttons
            const initialPanelFrontButton = document.querySelector(
              ".flex-shrink-0.flex.items-center.gap-1.sm\\:gap-2.bg-white.border.border-gray-300.hover\\:bg-gray-100.text-gray-800.text-\\[10px\\].sm\\:text-sm.px-1\\.5.sm\\:px-3.py-0\\.5.sm\\:py-1\\.5.rounded.transition.h-6.sm\\:h-8:nth-of-type(1)"
            );
            const initialPanelBackButton = document.querySelector(
              ".flex-shrink-0.flex.items-center.gap-1.sm\\:gap-2.bg-white.border.border-gray-300.hover\\:bg-gray-100.text-gray-800.text-\\[10px\\].sm\\:text-sm.px-1\\.5.sm\\:px-3.py-0\\.5.sm\\:py-1\\.5.rounded.transition.h-6.sm\\:h-8:nth-of-type(2)"
            );
            if (initialPanelFrontButton)
              initialPanelFrontButton.classList.add("bg-gray-200");
            if (initialPanelBackButton)
              initialPanelBackButton.classList.remove("bg-gray-200");
          } catch (e) {
            console.error("Error parsing saved design from localStorage:", e);
            // Reset design data if parsing fails to avoid errors
            frontDesignData.objects = [];
            frontDesignData.canvasWidth = 0;
            frontDesignData.canvasHeight = 0;
            backDesignData.objects = [];
            backDesignData.canvasWidth = 0;
            backDesignData.canvasHeight = 0;
            updateDesignList();
          }
        } else {
          // If no saved design, ensure updateDesignList is called
          updateDesignList();
        }

        // Set default zoom to 75% after all other initializations
        // Pastikan zoomSelect sudah tersedia
        const zoomSelect = document.querySelector(
          ".flex.items-center.gap-1.sm\\:gap-2.flex-shrink-0 > select"
        );
        if (zoomSelect) {
          zoomSelect.value = "75%"; // Set the dropdown to 75%
          applyZoom(75); // Apply the 75% zoom programmatically
        }

        updateUIFromActiveObject();

        // Add event listeners for autosave
        // Trigger autosave when an object is added, modified, or removed
        if (canvas) {
          canvas.on("object:added", saveDesignAutomatically);
          canvas.on("object:modified", saveDesignAutomatically);
          canvas.on("object:removed", saveDesignAutomatically);
          // When selection is cleared (e.g., user clicks off object), it might also mean a change
          canvas.on("selection:cleared", saveDesignAutomatically);
        } else {
          console.warn("Canvas not ready for autosave event listeners.");
        }

        canvas.renderAll();
      });
    </script>
  </body>
</html>
